
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizador de Estado Imperativo · Scala)</title>
  <style>
    :root{
      --bg:#f8fafc; --text:#334155; --muted:#64748b; --panel:#ffffff;
      --border:#e2e8f0; --brand:#4f46e5; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --ink:#0f172a; --accent:#6366f1; --code-op:#b45309; --code-num:#065f46;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;display:flex;flex-direction:column}
    .mono{font-family:'JetBrains Mono','Fira Code',Consolas,monospace;font-variant-ligatures:none}
    .header{background:#1e293b;color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #334155}
    .header h1{font-size:1.05rem;margin:0;letter-spacing:.25px}
    .header .badge{background:#6366f1;color:#fff;padding:4px 10px;border-radius:12px;font-size:.72rem;font-weight:700}
    .main{flex:1;display:flex;min-height:0}
    .sidebar{width:290px;background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column}
    .sidebar .title{padding:10px 14px;font-size:.72rem;text-transform:uppercase;color:#64748b;background:#f1f5f9;font-weight:800;border-bottom:1px solid var(--border)}
    .ex-list{flex:1;overflow:auto}
    .ex-btn{display:block;width:100%;padding:10px 14px;text-align:left;background:transparent;border:0;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .ex-btn strong{display:block;font-size:.9rem;color:#0f172a}
    .ex-btn small{display:block;color:#64748b}
    .ex-btn:hover{background:#f8fafc}
    .ex-btn.active{background:#eef2ff;border-left:4px solid var(--brand)}
    .workspace{flex:1;display:flex;flex-direction:column;min-width:0}
    .panels{display:grid;grid-template-columns:1.1fr 0.9fr;gap:12px;padding:14px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 16px -8px rgba(0,0,0,.15);display:flex;flex-direction:column;min-height:160px}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:.9rem;color:var(--ink)}
    .panel-body{padding:10px 12px;overflow:auto}
    .code{background:#ffffff;color:#0f172a;border-radius:8px;padding:10px 12px;border:1px solid var(--border)}
    .code .line{display:flex;gap:10px;align-items:flex-start;padding:2px 0;border-left:3px solid transparent}
    .code .ln{width:2.5ch;color:#94a3b8;text-align:right;user-select:none}
    .code .src{flex:1;white-space:pre-wrap}
    .code .active{background:rgba(99,102,241,.10);border-left-color:#6366f1}
    .t-op{color:var(--code-op)}
    .t-num{color:var(--code-num)}
    .t-kwd{color:#1d4ed8}
    .t-cmt{color:#64748b}
    .controls{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px;border-top:1px solid var(--border);background:#fff}
    .btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:#fff;color:#1f2937;font-weight:600;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.primary{border-color:#6366f1;background:#6366f1;color:#fff}
    .btn.ghost{background:#f1f5f9}
    .msg{min-width:260px;text-align:center;color:#64748b}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:.9rem;text-align:center}
    th{position:sticky;top:0;background:#f8fafc;color:#0f172a;z-index:1}
    tbody tr.now{background:#fffbeb}
    .val-new{color:var(--ok);font-weight:700}
    .val-unchanged{color:#64748b}
    .hint{padding:8px 14px;color:#475569;font-size:.85rem}
    .badge-note{display:inline-block;padding:2px 8px;border-radius:9999px;background:#ecfeff;color:#0891b2;border:1px solid #67e8f9;font-weight:700;font-size:.72rem}
  </style>
</head>
<body>
  <div class="header">
    <h1>Visualizador de Estado Imperativo</h1>
    <span class="badge">Scala Tema 2</span>
  </div>
  <div class="main">
    <aside class="sidebar">
      <div class="title">Ejemplos</div>
      <div id="exList" class="ex-list"></div>
      <div class="hint">
        <div><span class="badge-note">Ayuda</span> Usa ⬅️/➡️ para retroceder/avanzar. Enter para avanzar.</div>
      </div>
    </aside>

    <section class="workspace">
      <div class="panels">
        <div class="panel">
          <h3>Programa (línea actual resaltada)</h3>
          <div class="panel-body">
            <div id="codeBox" class="code mono" role="region" aria-label="Código"></div>
          </div>
        </div>
        <div class="panel">
          <h3>Traza de variables / expresiones</h3>
          <div class="panel-body">
            <table id="traceTable" class="mono" aria-label="Traza de variables"></table>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="btnReset" class="btn ghost" title="Reiniciar ejemplo">↺ Reiniciar</button>
        <button id="btnPrev" class="btn" title="Paso anterior">⬅️ Atrás</button>
        <button id="btnNext" class="btn primary" title="Siguiente paso">➡️ Siguiente</button>
        <div id="msg" class="msg" aria-live="polite">Selecciona un ejemplo en la izquierda</div>
      </div>
    </section>
  </div>

  <script>
    // ——————————————————————————————
    // Datos de ejemplos (inspirados en Tema 2)
    // ——————————————————————————————

    const EXAMPLES = [
      {
        cat: 'Secuencias',
        name: 'Variables y asignaciones',
        refs: 'Tema 2 · Variables y traza',
        code: [
          'var x: Int = 10',
          'var y = 20',
          'var z = x',
          'x = y',
          'y = z',
          'x = x + 1',
          'x += 1'
        ],
        steps: [
          { line: 0, note: 'Se crea x con valor 10', delta: { x: 10 } },
          { line: 1, note: 'Se crea y con valor 20', delta: { y: 20 } },
          { line: 2, note: 'Se crea z copiando el valor actual de x', delta: { z: 10 } },
          { line: 3, note: 'x toma el valor actual de y', delta: { x: 20 } },
          { line: 4, note: 'y toma el valor actual de z', delta: { y: 10 } },
          { line: 5, note: 'x recibe x + 1', delta: { x: 21 } },
          { line: 6, note: 'x aumenta en 1 (azúcar sintáctico)', delta: { x: 22 } },
        ]
      },
      {
        cat: 'Condicionales',
        name: 'Valor absoluto (if sin else)',
        refs: 'Tema 2 · Condicional sin else',
        code: [
          'var x: Int = -7',
          'if x < 0 then',
          '  x = -x',
          '// después: x >= 0'
        ],
        steps: [
          { line: 0, note: 'Estado inicial', delta: { x: -7 } },
          { line: 1, note: 'Se evalúa la condición x < 0', delta: {}, exprs: { 'x < 0': true } },
          { line: 2, note: 'Como la condición es true, se ejecuta la rama: x = -x', delta: { x: 7 } },
          { line: 3, note: 'Postcondición esperada: x ≥ 0', delta: {} },
        ]
      },
      {
        cat: 'Condicionales',
        name: 'Intercambio con bloque (swap)',
        refs: 'Tema 2 · Ejemplo: intercambio',
        code: [
          'var x = 8; var y = 3',
          'if x > y then',
          '  val temp = x',
          '  x = y',
          '  y = temp'
        ],
        steps: [
          { line: 0, note: 'Estado inicial', delta: { x: 8, y: 3 } },
          { line: 1, note: '¿x > y? — true → entra en la rama', delta: {}, exprs: { 'x > y': true } },
          { line: 2, note: 'temp guarda el valor original de x', delta: { temp: 8 } },
          { line: 3, note: 'x toma el valor de y', delta: { x: 3 } },
          { line: 4, note: 'y toma el valor de temp (el x original)', delta: { y: 8 } },
        ]
      },
      {
        cat: 'While',
        name: 'Sumatorio iterativo (contador)',
        refs: 'Tema 2 · sumatorioIt',
        code: [
          'def sumatorioIt(n: Int): Int =',
          '  require(n >= 0)',
          '  var ac = 0',
          '  var i = n',
          '  while i > 0 do',
          '    ac = ac + i',
          '    i = i - 1',
          '  ac',
          '',
          '// Demostración con n = 3'
        ],
        steps: [
          { line: 2, note: 'Inicialización del acumulador', delta: { n: 3, ac: 0 } },
          { line: 3, note: 'Inicialización del contador', delta: { i: 3 } },
          { line: 4, note: '¿i > 0? — true', delta: {}, exprs: { 'i > 0': true } },
          { line: 5, note: 'ac = ac + i', delta: { ac: 3 } },
          { line: 6, note: 'i = i - 1', delta: { i: 2 } },
          { line: 4, note: '¿i > 0? — true', delta: {}, exprs: { 'i > 0': true } },
          { line: 5, note: 'ac = ac + i', delta: { ac: 5 } },
          { line: 6, note: 'i = i - 1', delta: { i: 1 } },
          { line: 4, note: '¿i > 0? — true', delta: {}, exprs: { 'i > 0': true } },
          { line: 5, note: 'ac = ac + i', delta: { ac: 6 } },
          { line: 6, note: 'i = i - 1', delta: { i: 0 } },
          { line: 4, note: '¿i > 0? — false → termina el bucle', delta: {}, exprs: { 'i > 0': false } },
          { line: 7, note: 'Resultado: ac', delta: {} },
        ]
      },
      {
        cat: 'While',
        name: 'Centinela: sacar un 6',
        refs: 'Tema 2 · centinelas',
        code: [
          'val alt = Random(0)',
          'var c = 0',
          'var encontrado = false',
          'while !encontrado do',
          '  val d = alt.int(1, 7)',
          '  c = c + 1',
          '  encontrado = (d == 6)',
          'c'
        ],
        steps: [
          { line: 0, note: 'Generador inicializado con semilla 0', delta: {} },
          { line: 1, note: 'Contador de tiradas', delta: { c: 0 } },
          { line: 2, note: 'Centinela inicial', delta: { encontrado: false } },
          { line: 3, note: '¿!encontrado? — true', delta: {}, exprs: { '!encontrado': true } },
          { line: 4, note: 'Tirada: d = 2', delta: { d: 2 } },
          { line: 5, note: 'Incrementa c', delta: { c: 1 } },
          { line: 6, note: '¿d == 6? — false (centinela sigue a false)', delta: { encontrado: false } },
          { line: 3, note: '¿!encontrado? — true', delta: {}, exprs: { '!encontrado': true } },
          { line: 4, note: 'Tirada: d = 5', delta: { d: 5 } },
          { line: 5, note: 'Incrementa c', delta: { c: 2 } },
          { line: 6, note: '¿d == 6? — false (centinela sigue a false)', delta: { encontrado: false } },
          { line: 3, note: '¿!encontrado? — true', delta: {}, exprs: { '!encontrado': true } },
          { line: 4, note: 'Tirada: d = 6', delta: { d: 6 } },
          { line: 5, note: 'Incrementa c', delta: { c: 3 } },
          { line: 6, note: 'Centinela pasa a true', delta: { encontrado: true } },
          { line: 3, note: '¿!encontrado? — false → sale', delta: {}, exprs: { '!encontrado': false } },
          { line: 7, note: 'Devuelve c (nº tiradas)', delta: {} },
        ]
      },
      {
        cat: 'For',
        name: 'for ... to ... (sumatorio)',
        refs: 'Tema 2 · for con contador',
        code: [
          'val n = 4',
          'var ac = 0',
          'for i <- 1 to n do',
          '  ac = ac + i',
          'ac'
        ],
        steps: [
          { line: 0, note: 'Límite superior n', delta: { n: 4 } },
          { line: 1, note: 'Inicializa acumulador', delta: { ac: 0 } },
          { line: 2, note: 'Iteración i = 1', delta: { i: 1 }, exprs: { 'rango': '1..4' } },
          { line: 3, note: 'ac = ac + i', delta: { ac: 1 } },
          { line: 2, note: 'Iteración i = 2', delta: { i: 2 } },
          { line: 3, note: 'ac = ac + i', delta: { ac: 3 } },
          { line: 2, note: 'Iteración i = 3', delta: { i: 3 } },
          { line: 3, note: 'ac = ac + i', delta: { ac: 6 } },
          { line: 2, note: 'Iteración i = 4', delta: { i: 4 } },
          { line: 3, note: 'ac = ac + i', delta: { ac: 10 } },
          { line: 4, note: 'Resultado: ac', delta: {} },
        ]
      },
      {
        cat: 'For',
        name: 'for ... until ...',
        refs: 'Tema 2 · (until excluye el extremo)',
        code: [
          'val n = 4',
          'for i <- 0 until n do',
          '  // cuerpo (se ejecuta con i = 0,1,2,3)'
        ],
        steps: [
          { line: 0, note: 'n = 4', delta: { n: 4 } },
          { line: 1, note: 'i = 0', delta: { i: 0 } },
          { line: 2, note: 'cuerpo con i = 0', delta: {} },
          { line: 1, note: 'i = 1', delta: { i: 1 } },
          { line: 2, note: 'cuerpo con i = 1', delta: {} },
          { line: 1, note: 'i = 2', delta: { i: 2 } },
          { line: 2, note: 'cuerpo con i = 2', delta: {} },
          { line: 1, note: 'i = 3', delta: { i: 3 } },
          { line: 2, note: 'cuerpo con i = 3', delta: {} },
        ]
      },
      {
        cat: 'For',
        name: 'for ... by ... (paso)',
        refs: 'Tema 2 · (by k)',
        code: [
          'for i <- 0 to 10 by 3 do',
          '  // cuerpo (i = 0, 3, 6, 9)'
        ],
        steps: [
          { line: 0, note: 'i = 0', delta: { i: 0 } },
          { line: 1, note: 'cuerpo con i = 0', delta: {} },
          { line: 0, note: 'i = 3', delta: { i: 3 } },
          { line: 1, note: 'cuerpo con i = 3', delta: {} },
          { line: 0, note: 'i = 6', delta: { i: 6 } },
          { line: 1, note: 'cuerpo con i = 6', delta: {} },
          { line: 0, note: 'i = 9', delta: { i: 9 } },
          { line: 1, note: 'cuerpo con i = 9', delta: {} },
        ]
      },
    ];

    // ——————————————————————————————
    // Estado de la UI
    // ——————————————————————————————
    let current = -1;           // índice de ejemplo
    let step = -1;              // índice de paso actual (–1 = sin iniciar)
    let snapshot = {};          // estado actual (variables)
    let history = [];           // snapshots *completos* por paso
    let notes = [];             // notas por paso (para retroceso)
    let columns = [];           // columnas de la tabla (variables + exprs)

    const ui = {
      exList: document.getElementById('exList'),
      codeBox: document.getElementById('codeBox'),
      trace: document.getElementById('traceTable'),
      btnPrev: document.getElementById('btnPrev'),
      btnNext: document.getElementById('btnNext'),
      btnReset: document.getElementById('btnReset'),
      msg: document.getElementById('msg'),
    };

    // ——————————————————————————————
    // Sidebar
    // ——————————————————————————————
    function renderSidebar(){
      ui.exList.innerHTML = '';
      let last = '';
      EXAMPLES.forEach((ex, i) => {
        if(ex.cat !== last){
          const h = document.createElement('div');
          h.className = 'title';
          h.textContent = ex.cat;
          ui.exList.appendChild(h);
          last = ex.cat;
        }
        const b = document.createElement('button');
        b.className = 'ex-btn';
        b.innerHTML = `<strong>${ex.name}</strong><small>${ex.refs}</small>`;
        b.onclick = () => loadExample(i);
        b.dataset.idx = i;
        ui.exList.appendChild(b);
      });
    }

    function highlightActiveBtn(){
      const all = ui.exList.querySelectorAll('.ex-btn');
      all.forEach(el => el.classList.remove('active'));
      const act = Array.from(all).find(el => Number(el.dataset.idx) === current);
      if(act) act.classList.add('active');
    }

    // ——————————————————————————————
    // Carga y reinicio
    // ——————————————————————————————
    function loadExample(idx){
      current = idx; step = -1; snapshot = {}; history = []; notes = []; columns = [];
      highlightActiveBtn();
      computeColumns();
      renderCode();
      renderTable();
      ui.msg.textContent = 'Pulsa “Siguiente” para comenzar';
      updateButtons();
    }

    function reset(){ if(current>=0) loadExample(current); }

    // ——————————————————————————————
    // Columnas de la traza
    // ——————————————————————————————
    function computeColumns(){
      const ex = EXAMPLES[current];
      const set = new Set(['Paso']);
      const addKeys = obj => { if(!obj) return; Object.keys(obj).forEach(k => set.add(k)); };
      ex.steps.forEach(st => { addKeys(st.delta); addKeys(st.exprs); });
      columns = Array.from(set);
    }

    // ——————————————————————————————
    // Avanzar / retroceder
    // ——————————————————————————————
    function next(){
      const ex = EXAMPLES[current];
      if(step+1 >= ex.steps.length) return;
      step++;
      applyStep(ex.steps[step]);
      renderCode();
      renderTable();
      updateButtons();
    }

    function prev(){
      if(step < 0) return;
      step--;
      // Recalcula snapshot + history + notes hasta el nuevo step
      snapshot = {}; history = []; notes = [];
      const ex = EXAMPLES[current];
      for(let i=0;i<=step;i++) applyStep(ex.steps[i], /*silent*/true);
      renderCode();
      renderTable();
      // NUEVO: actualizar mensaje con la nota del paso actual (o mensaje inicial si step = -1)
      if(step >= 0) ui.msg.textContent = notes[step] || '';
      else ui.msg.textContent = 'Pulsa “Siguiente” para comenzar';
      updateButtons();
    }

    function applyStep(st, silent=false){
      // Mezcla delta en snapshot
      if(st.delta){ for(const [k,v] of Object.entries(st.delta)) snapshot[k] = v; }
      // Añade exprs (no modifican estado real)
      const exprs = st.exprs || {};
      const snapFull = { ...snapshot, ...exprs };
      history.push(snapFull);
      notes.push(st.note || '');
      if(!silent) ui.msg.textContent = st.note || '';
    }

    // ——————————————————————————————
    // Render de código (tema claro + línea activa) — sin innerHTML
    // ——————————————————————————————
    function renderCode(){
      const ex = EXAMPLES[current];
      if(!ex){ ui.codeBox.innerHTML = ''; return; }
      const activeLine = step>=0 ? ex.steps[step].line : -1;
      const lines = ex.code;
      ui.codeBox.innerHTML = '';
      lines.forEach((src, i) => {
        const div = document.createElement('div');
        div.className = 'line' + (i===activeLine ? ' active' : '');
        const ln = document.createElement('div'); ln.className='ln'; ln.textContent = (i+1).toString();
        const code = document.createElement('div'); code.className='src';
        renderLineTo(code, src);
        div.appendChild(ln); div.appendChild(code); ui.codeBox.appendChild(div);
      });
    }

    function renderLineTo(container, s){
      const pattern = /(\/\/.*)|\b(def|var|val|if|then|else|while|for|do|return|Int|Boolean)\b|(\b\d+\b)|([+\-*\/%=<>!]+)/g;
      let last = 0; let m;
      while((m = pattern.exec(s)) !== null){
        if(m.index > last){ container.appendChild(document.createTextNode(s.slice(last, m.index))); }
        const [tok, comment, kwd, num, op] = m;
        const span = document.createElement('span');
        if(comment){ span.className = 't-cmt'; span.textContent = comment; container.appendChild(span); last = pattern.lastIndex; break; }
        else if(kwd){ span.className = 't-kwd'; span.textContent = kwd; }
        else if(num){ span.className = 't-num'; span.textContent = num; }
        else if(op){ span.className = 't-op'; span.textContent = op; }
        container.appendChild(span);
        last = pattern.lastIndex;
      }
      if(last < s.length){ container.appendChild(document.createTextNode(s.slice(last))); }
    }

    // ——————————————————————————————
    // Tabla de traza
    // ——————————————————————————————
    function renderTable(){
      if(current<0){ ui.trace.innerHTML=''; return; }
      const thead = `<thead><tr>${columns.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
      const rows = history.map((snap, idx) => {
        const cells = columns.map((h) => {
          if(h==='Paso') return `<td>${idx+1}</td>`;
          const v = (h in snap) ? snap[h] : '';
          let cls = '';
          if(idx>0){ const prev = history[idx-1][h]; if(v!=='' && v!==prev) cls='val-new'; else if(v!=='' && v===prev) cls='val-unchanged'; }
          return `<td class="${cls}">${v===true?'true':v===false?'false':(v??'')}</td>`;
        }).join('');
        return `<tr class="${idx===history.length-1?'now':''}">${cells}</tr>`;
      }).join('');
      ui.trace.innerHTML = thead + '<tbody>' + rows + '</tbody>';
    }

    function updateButtons(){
      const ex = EXAMPLES[current];
      ui.btnPrev.disabled = (step < 0);
      ui.btnNext.disabled = (!ex || step >= ex.steps.length-1);
    }

    // ——————————————————————————————
    // Eventos
    // ——————————————————————————————
    renderSidebar();
    ui.btnNext.addEventListener('click', next);
    ui.btnPrev.addEventListener('click', prev);
    ui.btnReset.addEventListener('click', reset);

    window.addEventListener('keydown', (e)=>{
      if(current<0) return;
      if(e.key === 'ArrowRight' || e.key === 'Enter'){ e.preventDefault(); next(); }
      if(e.key === 'ArrowLeft'){ e.preventDefault(); prev(); }
      if(e.key.toLowerCase() === 'r' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); reset(); }
    });
  </script>
</body>
</html>
